/*
 * Copyright (c) 2018-2019, NVIDIA CORPORATION.  All rights reserved.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#include "dt-bindings/clock/tegra194-clock.h"

#define CAM0_RST_L	TEGRA194_MAIN_GPIO(H, 3)
#define CAMERA_I2C_MUX_BUS(x) (0x1E + x)

/* camera control gpio definitions */

/ {
	i2c@c250000 {
		#address-cells = <1>;
		#size-cells = <0>;

		tca9546@72 {
			compatible = "nxp,pca9546";
			reg = <0x72>;
			#address-cells = <1>;
			#size-cells = <0>;
			skip_mux_detect = "yes";
			vif-supply = <&p2822_vdd_1v8_cvb>;
			vcc-supply = <&p2822_vdd_1v8_cvb>;
			vcc_lp = "vcc";
			force_bus_start = <CAMERA_I2C_MUX_BUS(0)>;

			// I2C mux select 0 on JCB002
			i2c@0 {
				reg = <0>;
				i2c-mux,deselect-on-exit;
				#address-cells = <1>;
				#size-cells = <0>;

				dser_a_ar0820: max9296@48 {
					compatible = "nvidia,max9296";
					reg = <0x48>;
					csi-mode = "2x4";
					max-src = <1>;
					reset-gpios =  <&tegra_main_gpio 0x3b GPIO_ACTIVE_HIGH>;
				};

				ser_a_ar0820: max9295_prim@62 {
					compatible = "nvidia,max9295";
					reg = <0x62>;
				};

				ar0820_a: ar0820_a@10 {
					compatible = "nvidia,ar0820";
					reg = <0x10>;
					def-addr = <0x10>;
					reg_mux = <0x1>;
					physical_w = "15.0";
					physical_h = "12.5";
					sensor_model = "ar0820";
					post_crop_frame_drop = [30 00];
					use_decibel_gain = "true";
					use_sensor_mode_id = "true";
					clocks = <0x4 0x24 0x4 0x24>;
					clock-names = "extperiph1", "pllp_grtba";
					mclk = "extperiph1";
					nvidia,gmsl-ser-device = <&ser_a_ar0820>;
					nvidia,gmsl-dser-device = <&dser_a_ar0820>;	

					mode0 {
						default_framerate = "30000000";
						step_exp_time = [31 00];
						line_length = "1336";
						active_w = "3840";
						embedded_metadata_height = [30 00];
						pixel_phase = "grbg";
						pix_clk_hz = "156000000";
						dynamic_pixel_bit_depth = "12";
						dpcm_enable = "false";
						mode_type = "bayer";
						num_lanes = [34 00];
						inherent_gain = [31 00];
						max_gain_val = "499";
						min_hdr_ratio = [31 00];
						discontinuous_clk = "no";
						readout_orientation = [30 00];
						min_gain_val = "399";
						max_hdr_ratio = [31 00];
						tegra_sinterface = "serial_g";
						step_gain_val = [31 00];
						default_gain = "399";
						csi_pixel_bit_depth = "12";
						min_framerate = "30000000";
						default_exp_time = "1000";
						max_framerate = "30000000";
						exposure_factor = "1000000";
						step_framerate = [31 00];
						phy_mode = "DPHY";
						mclk_khz = "27000";
						cil_settletime = [30 00];
						gain_factor = "100";
						framerate_factor = "1000000";
						active_h = "2160";
						serdes_pix_clk_hz = "1500000000";
						max_exp_time = "6800";
						min_exp_time = "100";
					};

					ports {
						reg = <0x0>;
						#address-cells = <1>;
						#size-cells = <0>;
						
						port@0 {
							reg = <0>;
							ar0820_a_out: endpoint {
								vc-id = <0x0>;
								port-index = <0x6>;
								bus-width = <0x4>;
								remote-endpoint = <&csi_chan0_port0>;
							};
						};
					};

					gmsl-link {
						src-csi-port = "b";
						dst-csi-port = "a";
						serdes-csi-link = "a";
						csi-mode = "1x4";
						st-vc = <0x0>;
						vc-id = <0x0>;
						num-lanes = <0x4>;
						streams = "raw12";
					};
				};
			};

			// I2C mux select 1 on JCB002
			i2c@1 {
				reg = <1>;
				i2c-mux,deselect-on-exit;
				#address-cells = <1>;
				#size-cells = <0>;

				dser_b_ar0820: max9296@48 {
					compatible = "nvidia,max9296";
					reg = <0x48>;
					csi-mode = "2x4";
					max-src = <1>;
					reset-gpios =  <&tegra_main_gpio 0x3e GPIO_ACTIVE_HIGH>;
				};

				ser_b_ar0820: max9295_prim@62 {
					compatible = "nvidia,max9295";
					reg = <0x62>;
				};

				ar0820_b:  ar0820_b@10 {
					compatible = "nvidia,ar0820";
					reg = <0x10>;
					def-addr = <0x10>;
					reg_mux = <0x1>;
					physical_w = "15.0";
					physical_h = "12.5";
					sensor_model = "ar0820";
					post_crop_frame_drop = [30 00];
					use_decibel_gain = "true";
					use_sensor_mode_id = "true";
					clocks = <0x4 0x24 0x4 0x24>;
					clock-names = "extperiph1", "pllp_grtba";
					mclk = "extperiph1";
					nvidia,gmsl-ser-device = <&ser_b_ar0820>;
					nvidia,gmsl-dser-device = <&dser_b_ar0820>;	

					mode0 {
						default_framerate = "30000000";
						step_exp_time = [31 00];
						line_length = "1336";
						active_w = "3840";
						embedded_metadata_height = [30 00];
						pixel_phase = "grbg";
						pix_clk_hz = "156000000";
						dynamic_pixel_bit_depth = "12";
						dpcm_enable = "false";
						mode_type = "bayer";
						num_lanes = [34 00];
						inherent_gain = [31 00];
						max_gain_val = "499";
						min_hdr_ratio = [31 00];
						discontinuous_clk = "no";
						readout_orientation = [30 00];
						min_gain_val = "399";
						max_hdr_ratio = [31 00];
						tegra_sinterface = "serial_g";
						step_gain_val = [31 00];
						default_gain = "399";
						csi_pixel_bit_depth = "12";
						min_framerate = "30000000";
						default_exp_time = "1000";
						max_framerate = "30000000";
						exposure_factor = "1000000";
						step_framerate = [31 00];
						phy_mode = "DPHY";
						mclk_khz = "27000";
						cil_settletime = [30 00];
						gain_factor = "100";
						framerate_factor = "1000000";
						active_h = "2160";
						serdes_pix_clk_hz = "1500000000";
						max_exp_time = "6800";
						min_exp_time = "100";
					};

					ports {
						reg = <0x0>;
						#address-cells = <1>;
						#size-cells = <0>;

						port@0 {
							reg = <0>;
							ar0820_b_out: endpoint {
								vc-id = <0x0>;
								port-index = <0x4>;
								bus-width = <0x4>;
								remote-endpoint = <&csi_chan1_port0>;
							};
						};
					};

					gmsl-link {
						src-csi-port = "b";
						dst-csi-port = "a";
						serdes-csi-link = "a";
						csi-mode = "1x4";
						st-vc = <0x0>;
						vc-id = <0x0>;
						num-lanes = <0x4>;
						streams = "raw12";
					};
				};
			};


			// I2C mux select 2 on JCB002
			i2c@2 {
				reg = <2>;
				i2c-mux,deselect-on-exit;
				#address-cells = <1>;
				#size-cells = <0>;

				dser_c_ar0820: max9296@48 {
					compatible = "nvidia,max9296";
					reg = <0x48>;
					csi-mode = "2x4";
					max-src = <1>;
					reset-gpios =  <&tegra_main_gpio 0x9e GPIO_ACTIVE_HIGH>;
				};

				ser_c_ar0820: max9295_prim@62 {
					compatible = "nvidia,max9295";
					reg = <0x62>;
				};

				ar0820_c: ar0820_c@10 {
					compatible = "nvidia,ar0820";
					reg = <0x10>;
					def-addr = <0x10>;
					reg_mux = <0x1>;
					physical_w = "15.0";
					physical_h = "12.5";
					sensor_model = "ar0820";
					post_crop_frame_drop = [30 00];
					use_decibel_gain = "true";
					use_sensor_mode_id = "true";
					clocks = <0x4 0x24 0x4 0x24>;
					clock-names = "extperiph1", "pllp_grtba";
					mclk = "extperiph1";
					nvidia,gmsl-ser-device = <&ser_c_ar0820>;
					nvidia,gmsl-dser-device = <&dser_c_ar0820>;	

					mode0 {
						default_framerate = "30000000";
						step_exp_time = [31 00];
						line_length = "1336";
						active_w = "3840";
						embedded_metadata_height = [30 00];
						pixel_phase = "grbg";
						pix_clk_hz = "156000000";
						dynamic_pixel_bit_depth = "12";
						dpcm_enable = "false";
						mode_type = "bayer";
						num_lanes = [34 00];
						inherent_gain = [31 00];
						max_gain_val = "499";
						min_hdr_ratio = [31 00];
						discontinuous_clk = "no";
						readout_orientation = [30 00];
						min_gain_val = "399";
						max_hdr_ratio = [31 00];
						tegra_sinterface = "serial_g";
						step_gain_val = [31 00];
						default_gain = "399";
						csi_pixel_bit_depth = "12";
						min_framerate = "30000000";
						default_exp_time = "1000";
						max_framerate = "30000000";
						exposure_factor = "1000000";
						step_framerate = [31 00];
						phy_mode = "DPHY";
						mclk_khz = "27000";
						cil_settletime = [30 00];
						gain_factor = "100";
						framerate_factor = "1000000";
						active_h = "2160";
						serdes_pix_clk_hz = "1500000000";
						max_exp_time = "6800";
						min_exp_time = "100";
					};

					ports {
						reg = <0x0>;
						#address-cells = <1>;
						#size-cells = <0>;

						port@0 {
							reg = <0>;
							ar0820_c_out: endpoint {
								vc-id = <0x0>;
								port-index = <0x2>;
								bus-width = <0x4>;
								remote-endpoint = <&csi_chan2_port0>;
							};
						};
					};

					gmsl-link {
						src-csi-port = "b";
						dst-csi-port = "a";
						serdes-csi-link = "a";
						csi-mode = "1x4";
						st-vc = <0x0>;
						vc-id = <0x0>;
						num-lanes = <0x4>;
						streams = "raw12";
					};
				};
			};

		
			// I2C mux select 1 on JCB002
			i2c@3 {
				reg = <3>;
				i2c-mux,deselect-on-exit;
				#address-cells = <1>;
					#size-cells = <0>;

				dser_d_ar0820: max9296@48 {
					compatible = "nvidia,max9296";
					reg = <0x48>;
					csi-mode = "2x4";
					max-src = <1>;
					reset-gpios =  <&tegra_main_gpio 0x9d GPIO_ACTIVE_HIGH>;
				};

				ser_d_ar0820: max9295_prim@62 {
					compatible = "nvidia,max9295";
					reg = <0x62>;
				};

				ar0820_d: ar0820_d@10 {
					compatible = "nvidia,ar0820";
					reg = <0x10>;
					def-addr = <0x10>;
					reg_mux = <0x1>;
					physical_w = "15.0";
					physical_h = "12.5";
					sensor_model = "ar0820";
					post_crop_frame_drop = [30 00];
					use_decibel_gain = "true";
					use_sensor_mode_id = "true";
					clocks = <0x4 0x24 0x4 0x24>;
					clock-names = "extperiph1", "pllp_grtba";
					mclk = "extperiph1";
					nvidia,gmsl-ser-device = <&ser_d_ar0820>;
					nvidia,gmsl-dser-device = <&dser_d_ar0820>;	

					mode0 {
						default_framerate = "30000000";
						step_exp_time = [31 00];
						line_length = "1336";
						active_w = "3840";
						embedded_metadata_height = [30 00];
						pixel_phase = "grbg";
						pix_clk_hz = "156000000";
						dynamic_pixel_bit_depth = "12";
						dpcm_enable = "false";
						mode_type = "bayer";
						num_lanes = [34 00];
						inherent_gain = [31 00];
						max_gain_val = "499";
						min_hdr_ratio = [31 00];
						discontinuous_clk = "no";
						readout_orientation = [30 00];
						min_gain_val = "399";
						max_hdr_ratio = [31 00];
						tegra_sinterface = "serial_g";
						step_gain_val = [31 00];
						default_gain = "399";
						csi_pixel_bit_depth = "12";
						min_framerate = "30000000";
						default_exp_time = "1000";
						max_framerate = "30000000";
						exposure_factor = "1000000";
						step_framerate = [31 00];
						phy_mode = "DPHY";
						mclk_khz = "27000";
						cil_settletime = [30 00];
						gain_factor = "100";
						framerate_factor = "1000000";
						active_h = "2160";
						serdes_pix_clk_hz = "1500000000";
						max_exp_time = "6800";
						min_exp_time = "100";
					};

					ports {
						#address-cells = <1>;
						#size-cells = <0>;
						reg = <0x0>;

						port@0 {
							reg = <0>;
							ar0820_d_out: endpoint {
								vc-id = <0x0>;
								port-index = <0x0>;
								bus-width = <0x4>;
								remote-endpoint = <&csi_chan3_port0>;
							};
						};
					};

					gmsl-link {
						src-csi-port = "b";
						dst-csi-port = "a";
						serdes-csi-link = "a";
						csi-mode = "1x4";
						st-vc = <0x0>;
						vc-id = <0x0>;
						num-lanes = <0x4>;
						streams = "raw12";
					};
				};
			};
		};	
	};

	host1x {
		vi_base: vi@15c10000 {
			#address-cells = <1>;
        		#size-cells = <0>;
			status = "okay";
			num-channels = <4>;

			ports {
				vi_port0: port@0 {
					#address-cells = <1>;
        			#size-cells = <0>;
					reg = <0>;
					status = "okay";
					vi_in0: endpoint {
						vc-id = <0>;
						port-index = <6>;
						bus-width = <0x4>;
						status = "okay";
						remote-endpoint = <&csi_chan0_port1>;
					};
				};
				vi_port1: port@1 {
					#address-cells = <1>;
        			#size-cells = <0>;
					reg = <1>;
					status = "okay";
					vi_in1: endpoint {
						vc-id = <0>;
						port-index = <4>;
						bus-width = <0x4>;
						status = "okay";
						remote-endpoint = <&csi_chan1_port1>;						
					};
				};
				vi_port2: port@2 {
					#address-cells = <1>;
        			#size-cells = <0>;
					reg = <2>;
					status = "okay";
					vi_in2: endpoint {
						vc-id = <0>;
						port-index = <2>;
						bus-width = <0x4>;
						status = "okay";
						remote-endpoint = <&csi_chan2_port1>;												
					};
				};
				vi_port3: port@3 {
					#address-cells = <1>;
        			#size-cells = <0>;
					reg = <3>;
					status = "okay";
					vi_in3: endpoint {
						vc-id = <0>;
						port-index = <0>;
						bus-width = <0x4>;
						status = "okay";
						remote-endpoint = <&csi_chan3_port1>;																};
				};
			};
		};

		csi_base: nvcsi@15a00000 {
			#address-cells = <1>;
        	#size-cells = <0>;
			num-tpg-channels = <36>;
			num-channels = <4>;
		 	status = "okay"; 
	
			csi_chan0: channel@0 {
				status = "okay";
				reg = <0>;
				ports {					
					csi_chan0_port0: port@0 {
						#address-cells = <1>;
        				#size-cells = <0>;					
						status = "okay";
						reg = <0>;
						csi_in0: endpoint@0 {
							status = "okay";
							port-index = <6>;
							bus-width  = <4>;
							remote-endpoint = <&ar0820_a_out>;

						};
					};
					csi_chan0_port1: port@1 {
						#address-cells = <1>;
        				#size-cells = <0>;
						status = "okay";
						reg = <1>;
						csi_out0: endpoint@1 {
							remote-endpoint = <&vi_port0>;
							status = "okay";
						};
					};
				};
			};
			csi_chan1: channel@1 {
				status = "okay";
				reg = <1>;
				ports {
					csi_chan1_port0: port@0 {
						#address-cells = <1>;
        				#size-cells = <0>;
						status = "okay";
						reg = <0>;
						csi_in1: endpoint@2 {
							status = "okay";
							port-index = <0x4>;
							bus-width = <0x4>;							
							remote-endpoint = <&ar0820_b_out>;
						};
					};
					csi_chan1_port1: port@1 {
						#address-cells = <1>;
        				#size-cells = <0>;
						status = "okay";
						reg = <1>;
						csi_out1: endpoint@3 {
							remote-endpoint = <&vi_port1>;
							status = "okay";
						};
					};
				};
			};
			csi_chan2: channel@2 {
				status = "okay";
				reg = <2>;
				ports {
					csi_chan2_port0: port@0 {
						#address-cells = <1>;
        				#size-cells = <0>;
						status = "okay";
						reg = <0>;
						csi_in2: endpoint@4 {
							status = "okay";
							port-index = <0x2>;
							bus-width = <0x4>;							
							remote-endpoint = <&ar0820_c_out>;
						};
					};
					csi_chan2_port1: port@1 {
						#address-cells = <1>;
        				#size-cells = <0>;
						status = "okay";
						reg = <1>;
						csi_out2: endpoint@5 {
							remote-endpoint = <&vi_port2>;
							status = "okay";
						};
					};
				};
			};
			csi_chan3: channel@3 {
				status = "okay";
				reg = <3>;
				ports {
					csi_chan3_port0: port@0 {
						#address-cells = <1>;
        				#size-cells = <0>;
						status = "okay";
						reg = <0>;
						csi_in3: endpoint@6 {
							status = "okay";
							port-index = <0x0>;
							bus-width = <0x4>;							
							remote-endpoint = <&ar0820_d_out>;
						};
					};
					csi_chan3_port1: port@1 {
						#address-cells = <1>;
        				#size-cells = <0>;
						status = "okay";
						reg = <1>;
						csi_out3: endpoint@7 {
							remote-endpoint = <&vi_port3>;
							status = "okay";
						};
					};
				};
			};
		};
	};

	tegra-camera-platform {
		compatible = "nvidia, tegra-camera-platform";
		num_csi_lanes = <16>;
		max_lane_speed = <1500000>;
		min_bits_per_pixel = <12>;
		vi_peak_byte_per_pixel = <2>;
		vi_bw_margin_pct = <25>;
		max_pixel_rate = <252979>;
		isp_peak_byte_per_pixel = <5>;
		isp_bw_margin_pct = <25>;

		modules {
			cam_module0: module0 {
				badge = "ar0820_a";
				position = "topleft";
				orientation = "1";
				drivernode0 {
					pcl_id = "v4l2_sensor";
					devname = "ar0820 30-0010";
					proc-device-tree = "/proc/device-tree/i2c@c250000/tca9546@72/i2c@0/ar0820_a@10";
				};
			};

			cam_module1: module1 {
				badge = "ar0820_b";
				position = "bottomleft";
				orientation = "1";
				drivernode0 {
					pcl_id = "v4l2_sensor";
					devname = "ar0820 31-0010";
					proc-device-tree = "/proc/device-tree/i2c@c250000/tca9546@72/i2c@1/ar0820_b@10";
				};
			};

			cam_module2: module2 {
				badge = "ar0820_c";
				position = "topright";
				orientation = "1";
				drivernode0 {
					pcl_id = "v4l2_sensor";
					devname = "ar0820 32-0010";
					proc-device-tree = "/proc/device-tree/i2c@c250000/tca9546@72/i2c@2/ar0820_c@10";
				};
			};

			cam_module3: module3 {
				badge = "ar0820_d";
				position = "bottomright";
				orientation = "1";
				drivernode0 {
					pcl_id = "v4l2_sensor";
					devname = "ar0820 33-0010";
					proc-device-tree = "/proc/device-tree/i2c@c250000/tca9546@72/i2c@3/ar0820_d@10";
				};
			};
		};
	};
	

	// ConnectTech JCB002 board requires 2v8 supply to power deserializers
	fixed-regulators {
		regulator@107 {
			regulator-always-on;
			regulator-boot-on;
		};
    };


	tegra-virtual-camera-platform
	{
		isp_bw_margin_pct = <0x19>;
		isp_peak_byte_per_pixel = <0x5>;

		modules
		{
			module0
			{
				badge = "vivid_front_instance0";
				position = "front";
				orientation = [31 00];

				drivernode0
				{
					devname = "tegra-vivid-000";
					pcl_id = "v4l2_sensor_virtual";
					proc-device-tree = "/proc/device-tree/vivid-driver/instances/instance0";
				};
			};
		};
	};

	vivid-driver
	{
		instance0
		{
			mode0
			{
				line_length = "2200";
				active_w = "1920";
				vert_front_porch = [34 00];
				horz_back_porch = "148";
				embedded_metadata_height = [31 00];
				pixel_t = "bayer_bggr10";
				pix_clk_hz = "74250000";
				max_gain_val = "256";
				vert_back_porch = "36";
				vert_sync = [35 00];
				readout_orientation = "90";
				min_gain_val = [31 00];
				tegra_sinterface = "host";
				min_framerate = [31 00];
				max_framerate = "30";
				horz_sync = "44";
				gain_factor = "16";
				framerate_factor = [31 00];
				active_h = "1080";
				max_exp_time = "999994";
				horz_front_porch = "88";
				min_exp_time = "34";
			};
		};
	};
};
